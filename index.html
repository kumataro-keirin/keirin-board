<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç«¶è¼ªäºˆæƒ³ãƒœãƒ¼ãƒ‰ï¼ˆ9è»Šãƒ»ã‚°ãƒ«ãƒ¼ãƒ—1ã€œ5ï¼‹ãƒ¡ãƒ¢ä»˜ãï¼‰</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
    }

    h1 {
      margin-bottom: 5px;
      font-size: 22px;
      font-weight: 900;
    }

    /* ä½œè€…ãƒªãƒ³ã‚¯è¡¨ç¤º */
    .author-box {
      margin-bottom: 15px;
      padding: 6px 12px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .author-box a {
      color: #1d9bf0;
      font-weight: bold;
      text-decoration: none;
    }
    .author-box a:hover {
      text-decoration: underline;
    }

    .controls {
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .btn:hover { background: #eee; }

    .btn-size-active {
      background: #333;
      color: #fff;
    }

    .btn-group-active {
      background: #005bbb;
      color: #fff;
    }

    .board-wrapper {
      width: 1200px;
      height: 700px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .label {
      font-size: 26px;
      font-weight: 900;
      letter-spacing: 2px;
      color: white;
      -webkit-text-stroke: 2px black;
      margin: 4px 0;
      user-select: none;
    }

    .track {
      position: relative;
      width: 1140px;
      height: 570px;
      background-image: url("bank.jpg");
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      background-color: #2f6b2f;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .rider {
      position: absolute;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 2px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: grab;
      user-select: none;
      touch-action: none;
      box-sizing: border-box;
      z-index: 3;
      transition: box-shadow 0.1s;
    }
    .rider:active { cursor: grabbing; }

    /* Shifté¸æŠ */
    .rider.selected {
      box-shadow: 0 0 0 3px rgba(255,0,0,0.6);
    }

    /* ã‚°ãƒ«ãƒ¼ãƒ—æ è‰² */
    .rider[data-group="1"] { box-shadow: 0 0 0 3px rgba(0,120,255,0.7); }
    .rider[data-group="2"] { box-shadow: 0 0 0 3px rgba(0,200,0,0.7); }
    .rider[data-group="3"] { box-shadow: 0 0 0 3px rgba(255,140,0,0.7); }
    .rider[data-group="4"] { box-shadow: 0 0 0 3px rgba(160,80,255,0.7); }
    .rider[data-group="5"] { box-shadow: 0 0 0 3px rgba(255,0,120,0.7); }

    /* è»Šç•ªè‰²ï¼‹åˆæœŸä½ç½® */
    .r1 { background:#fff;    color:#000; top:105px; left:570px; }
    .r2 { background:#000;    color:#fff; top:150px; left:705px; }
    .r3 { background:#ff4d4d; color:#000; top:225px; left:780px; }
    .r4 { background:#4d79ff; color:#000; top:308px; left:780px; }
    .r5 { background:#ffe44d; color:#000; top:383px; left:705px; }
    .r6 { background:#4dff4d; color:#000; top:428px; left:570px; }
    .r7 { background:#ff9933; color:#000; top:383px; left:435px; }
    .r8 { background:#ff66cc; color:#000; top:308px; left:360px; }
    .r9 { background:#b366ff; color:#000; top:225px; left:360px; }

    .hint {
      margin-top: 10px;
      font-size: 13px;
      color: #555;
      text-align: center;
      line-height: 1.6;
    }

    /* ãƒ¡ãƒ¢æ¬„ */
    .memo-wrapper {
      margin-top: 16px;
      width: 100%;
      max-width: 1200px;
    }
    .memo-title {
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    #memo {
      width: 100%;
      min-height: 120px;
      padding: 8px;
      font-size: 13px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
    }
    .memo-buttons {
      margin-top: 4px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

  <h1>ç«¶è¼ª äºˆæƒ³ãƒœãƒ¼ãƒ‰ï¼ˆ9è»Šï¼‰</h1>

  <!-- ä½œè€…Xãƒªãƒ³ã‚¯ -->
  <div class="author-box">
    ğŸ‰ ä½œè€…Xï¼ˆTwitterï¼‰ï¼š
    <a href="https://x.com/kumatarou_kuma_" target="_blank">@kumatarou_kuma_</a>
  </div>

  <div class="controls">
    <button class="btn" id="resetBtn">åˆæœŸä½ç½®ã«æˆ»ã™</button>
    <button class="btn" id="clearSelectionBtn">ãƒ©ã‚¤ãƒ³é¸æŠè§£é™¤</button>

    <button class="btn btn-size btn-size-active" data-size="small">ä¸¸ å°</button>
    <button class="btn btn-size" data-size="medium">ä¸¸ ä¸­</button>
    <button class="btn btn-size" data-size="large">ä¸¸ å¤§</button>

    <button class="btn group-mode-btn" data-group="1">G1</button>
    <button class="btn group-mode-btn" data-group="2">G2</button>
    <button class="btn group-mode-btn" data-group="3">G3</button>
    <button class="btn group-mode-btn" data-group="4">G4</button>
    <button class="btn group-mode-btn" data-group="5">G5</button>
    <button class="btn" id="clearGroupsBtn">å…¨è§£é™¤</button>
  </div>

  <div class="label">BACK</div>

  <div class="board-wrapper">
    <div class="track" id="track">
      <div class="rider r1">1</div>
      <div class="rider r2">2</div>
      <div class="rider r3">3</div>
      <div class="rider r4">4</div>
      <div class="rider r5">5</div>
      <div class="rider r6">6</div>
      <div class="rider r7">7</div>
      <div class="rider r8">8</div>
      <div class="rider r9">9</div>
    </div>
  </div>

  <div class="label">HOME</div>

  <div class="hint">
    â— G1ã€œG5 â†’ ã‚¿ãƒƒãƒ—ã§æ‰€å±å¤‰æ›´<br>
    â— ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã£ãŸä¸¸ã¯ã¾ã¨ã‚ã¦ç§»å‹•<br>
    â— ãƒ‰ãƒ©ãƒƒã‚°å¾Œã®èª¤ã‚¿ãƒƒãƒ—ã¯è‡ªå‹•ã§ç„¡åŠ¹åŒ–ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã¯å‹æ‰‹ã«å¤‰ã‚ã‚‰ãªã„ï¼‰
  </div>

  <!-- ãƒ¡ãƒ¢æ¬„ -->
  <div class="memo-wrapper">
    <div class="memo-title">ğŸ“ ãƒ¡ãƒ¢ï¼ˆã“ã®ç«¯æœ«ã ã‘ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰</div>
    <textarea id="memo" placeholder="ãƒ©ã‚¤ãƒ³æ§‹æˆã€å±•é–‹äºˆæƒ³ã€ã‚³ãƒ¡ãƒ³ãƒˆãªã©è‡ªç”±ã«ãƒ¡ãƒ¢ã§ãã¾ã™ã€‚"></textarea>
    <div class="memo-buttons">
      <button class="btn" id="saveMemoBtn">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
      <button class="btn" id="clearMemoBtn">ãƒ¡ãƒ¢ã‚’æ¶ˆå»</button>
    </div>
  </div>

<script>
(function () {
  const track = document.getElementById("track");
  const riders = Array.from(document.querySelectorAll(".rider"));
  const resetBtn = document.getElementById("resetBtn");
  const clearSelectionBtn = document.getElementById("clearSelectionBtn");
  const sizeButtons = Array.from(document.querySelectorAll(".btn-size"));
  const groupButtons = Array.from(document.querySelectorAll(".group-mode-btn"));
  const clearGroupsBtn = document.getElementById("clearGroupsBtn");

  const memo = document.getElementById("memo");
  const saveMemoBtn = document.getElementById("saveMemoBtn");
  const clearMemoBtn = document.getElementById("clearMemoBtn");
  const MEMO_KEY = "keirin-board-memo-v1";

  let isDragging = false;
  let dragItems = [];
  let startX = 0;
  let startY = 0;
  let didDrag = false;   // ãƒ‰ãƒ©ãƒƒã‚°å¾Œã®èª¤ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢

  const BASE_SIZE = 52;
  let currentGroupMode = null;

  window.addEventListener("load", () => {
    // åˆæœŸä½ç½®ä¿å­˜
    riders.forEach(r => {
      const cs = getComputedStyle(r);
      r.dataset.initLeft = cs.left;
      r.dataset.initTop = cs.top;
    });
    applySize("small");

    // ãƒ¡ãƒ¢èª­ã¿è¾¼ã¿ï¼ˆã“ã®ç«¯æœ«ã ã‘ï¼‰
    const saved = localStorage.getItem(MEMO_KEY);
    if (saved !== null) {
      memo.value = saved;
    }
  });

  function applySize(mode) {
    let scale;
    if (mode === "small") scale = 0.80;
    else if (mode === "large") scale = 1.25;
    else scale = 1.0;

    const newSize = BASE_SIZE * scale;
    riders.forEach(r => {
      r.style.width = newSize + "px";
      r.style.height = newSize + "px";
      r.style.fontSize = (newSize * 0.5) + "px";
    });

    sizeButtons.forEach(b => b.classList.remove("btn-size-active"));
    const active = sizeButtons.find(b => b.dataset.size === mode);
    if (active) active.classList.add("btn-size-active");
  }

  sizeButtons.forEach(btn => {
    btn.addEventListener("click", () => applySize(btn.dataset.size));
  });

  function updateGroupButtonStates() {
    groupButtons.forEach(btn => {
      btn.classList.toggle("btn-group-active", btn.dataset.group === currentGroupMode);
    });
  }

  groupButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const g = btn.dataset.group;
      currentGroupMode = (currentGroupMode === g ? null : g);
      updateGroupButtonStates();
    });
  });

  clearGroupsBtn.addEventListener("click", () => {
    currentGroupMode = null;
    updateGroupButtonStates();
    riders.forEach(r => delete r.dataset.group);
  });

  function selectedRiders() {
    return riders.filter(r => r.classList.contains("selected"));
  }

  // ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¿ãƒƒãƒ—ï¼‰æ™‚ï¼šãƒ‰ãƒ©ãƒƒã‚°å¾Œã®ãŠã¾ã‘ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
  track.addEventListener("click", (e) => {
    if (didDrag) {
      didDrag = false;
      return;
    }

    const r = e.target.closest(".rider");
    if (!r) return;

    if (currentGroupMode) {
      if (r.dataset.group === currentGroupMode) delete r.dataset.group;
      else r.dataset.group = currentGroupMode;
      return;
    }

    if (e.shiftKey) {
      r.classList.toggle("selected");
    }
  });

  function startDrag(e) {
    const target = e.target.closest(".rider");
    if (!target) return;

    if (!e.touches && e.shiftKey) return;

    isDragging = true;
    didDrag = false;

    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    startX = cx;
    startY = cy;

    let group = [];
    const gid = target.dataset.group;

    if (gid) {
      group = riders.filter(r => r.dataset.group === gid);
    } else {
      const sel = selectedRiders();
      group = (sel.length > 0 && sel.includes(target)) ? sel : [target];
    }

    dragItems = group.map(el => {
      const cs = getComputedStyle(el);
      return {
        el,
        startLeft: parseFloat(cs.left),
        startTop: parseFloat(cs.top)
      };
    });

    e.preventDefault();
  }

  function moveDrag(e) {
    if (!isDragging || dragItems.length === 0) return;

    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;

    const dx = cx - startX;
    const dy = cy - startY;

    if (Math.abs(dx) > 3 || Math.abs(dy) > 3) {
      didDrag = true;
    }

    const rect = track.getBoundingClientRect();

    dragItems.forEach(item => {
      const el = item.el;
      const maxX = rect.width - el.offsetWidth;
      const maxY = rect.height - el.offsetHeight;

      let left = item.startLeft + dx;
      let top = item.startTop + dy;

      left = Math.max(0, Math.min(maxX, left));
      top = Math.max(0, Math.min(maxY, top));

      el.style.left = left + "px";
      el.style.top = top + "px";
    });

    e.preventDefault();
  }

  function endDrag() {
    isDragging = false;
    dragItems = [];
  }

  function reset() {
    riders.forEach(r => {
      r.style.left = r.dataset.initLeft;
      r.style.top = r.dataset.initTop;
    });
  }

  function clearSelection() {
    riders.forEach(r => r.classList.remove("selected"));
  }

  // ãƒ¡ãƒ¢ä¿å­˜ãƒ»å‰Šé™¤
  saveMemoBtn.addEventListener("click", () => {
    localStorage.setItem(MEMO_KEY, memo.value);
    // å¿…è¦ãªã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã€‚ã†ã‚‹ã•ã‘ã‚Œã°æ¶ˆã—ã¦ã‚‚OKã€‚
    // alert("ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã ã‘ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰");
  });

  clearMemoBtn.addEventListener("click", () => {
    memo.value = "";
    localStorage.removeItem(MEMO_KEY);
  });

  track.addEventListener("mousedown", startDrag);
  window.addEventListener("mousemove", moveDrag);
  window.addEventListener("mouseup", endDrag);

  track.addEventListener("touchstart", startDrag, { passive:false });
  window.addEventListener("touchmove", moveDrag, { passive:false });
  window.addEventListener("touchend", endDrag);
  window.addEventListener("touchcancel", endDrag);

  resetBtn.addEventListener("click", reset);
  clearSelectionBtn.addEventListener("click", clearSelection);

})();
</script>

</body>
</html>
