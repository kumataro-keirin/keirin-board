<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç«¶è¼ªäºˆæƒ³ãƒœãƒ¼ãƒ‰ï¼ˆè¿½éšï¼‹ãƒ©ã‚¤ãƒ³ç°¡æ˜“ï¼‹å‡ºèµ°ãƒã‚§ãƒƒã‚¯ï¼‹é¸æ‰‹ãƒ¡ãƒ¢1äººï¼‰</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
    }

    h1 {
      margin-bottom: 5px;
      font-size: 22px;
      font-weight: 900;
    }

    .version-box {
      margin-top: 2px;
      margin-bottom: 10px;
      font-size: 12px;
      color: #666;
    }

    .author-box {
      margin-bottom: 15px;
      padding: 6px 12px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .author-box a {
      color: #1d9bf0;
      font-weight: bold;
      text-decoration: none;
    }
    .author-box a:hover {
      text-decoration: underline;
    }

    /* â–¼ ãƒãƒ³ã‚¯æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ */
    .bank-box {
      margin-bottom: 10px;
      padding: 8px 10px;
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      box-sizing: border-box;
    }
    .bank-box label {
      font-size: 14px;
      font-weight: 600;
    }
    .bank-box select {
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 160px;
    }
    .bank-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
      flex: 1 1 auto;
    }
    .bank-name-display {
      font-weight: 700;
    }
    .bank-tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #999;
      margin-right: 4px;
    }
    /* â–² ãƒãƒ³ã‚¯æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ */

    .controls {
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .btn:hover { background: #eee; }

    .btn-size-active {
      background: #333;
      color: #fff;
    }

    .btn-group-active {
      background: #005bbb;
      color: #fff;
    }

    .board-wrapper {
      width: 1200px;
      height: 700px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .track {
      position: relative;
      width: 1140px;
      height: 570px;
      background-image: url("bank.jpg");
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      background-color: #2f6b2f;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .rider {
      position: absolute;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 2px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: grab;
      user-select: none;
      touch-action: none;
      box-sizing: border-box;
      z-index: 3;
      transition: box-shadow 0.1s;
    }
    .rider:active { cursor: grabbing; }

    .rider.selected {
      box-shadow: 0 0 0 3px rgba(255,0,0,0.6);
    }

    .rider[data-group="1"] { box-shadow: 0 0 0 3px rgba(0,120,255,0.7); }
    .rider[data-group="2"] { box-shadow: 0 0 0 3px rgba(0,200,0,0.7); }
    .rider[data-group="3"] { box-shadow: 0 0 0 3px rgba(255,140,0,0.7); }
    .rider[data-group="4"] { box-shadow: 0 0 0 3px rgba(160,80,255,0.7); }
    .rider[data-group="5"] { box-shadow: 0 0 0 3px rgba(255,0,120,0.7); }

    .r1 { background:#fff;    color:#000; top:105px; left:570px; }
    .r2 { background:#000;    color:#fff; top:150px; left:705px; }
    .r3 { background:#ff4d4d; color:#000; top:225px; left:780px; }
    .r4 { background:#4d79ff; color:#000; top:308px; left:780px; }
    .r5 { background:#ffe44d; color:#000; top:383px; left:705px; }
    .r6 { background:#4dff4d; color:#000; top:428px; left:570px; }
    .r7 { background:#ff9933; color:#000; top:383px; left:435px; }
    .r8 { background:#ff66cc; color:#000; top:308px; left:360px; }
    .r9 { background:#b366ff; color:#000; top:225px; left:360px; }

    .hint {
      margin-top: 10px;
      font-size: 13px;
      color: #555;
      text-align: left;
      line-height: 1.8;
      max-width: 1200px;
    }

    /* â–¼ å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹å…±é€š */
    .line-inputs {
      width: 100%;
      max-width: 1200px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 10px;
      box-sizing: border-box;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .line-inputs-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .line-row-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      align-items: center;
    }
    .line-row {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .line-row label {
      font-size: 12px;
    }
    .line-row input {
      width: 70px;
      padding: 4px 4px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .line-row-button {
      margin-top: 6px;
    }

    /* â–¼ å‡ºèµ°è»Šç•ªãƒã‚§ãƒƒã‚¯ã®è¦‹ãŸç›® */
    #rider-checks-row label{
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fafafa;
    }

    /* â–¼ åºƒå‘Š */
    .ads-multi {
      margin-top: 12px;
      margin-bottom: 8px;
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
    }
    .ad-item {
      flex: 1 1 260px;
      min-width: 220px;
      min-height: 80px;
      background: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }
    .ad-title {
      font-size: 11px;
      font-weight: 700;
      color: #888;
      margin-bottom: 4px;
    }
    .ad-item a {
      color: #0066cc;
      text-decoration: none;
      font-weight: 600;
    }
    .ad-item a:hover {
      text-decoration: underline;
    }

    /* â–¼ ãƒ¡ãƒ¢æ¬„ */
    .memo-wrapper {
      margin-top: 16px;
      width: 100%;
      max-width: 1200px;
    }
    .memo-title {
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    #memo {
      width: 100%;
      min-height: 120px;
      padding: 8px;
      font-size: 13px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
    }
    .memo-buttons {
      margin-top: 4px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* â–¼ é¸æ‰‹ãƒ¡ãƒ¢ï¼ˆ1äººåˆ†ï¼‰ã‚¹ã‚¯ã‚·ãƒ§ç‰ˆ */
    .rider-memo-one{
      margin-top: 14px;
      width: 100%;
      max-width: 1200px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      box-sizing: border-box;
    }
    .rider-memo-one-head{
      display:flex;
      gap:10px;
      align-items: baseline;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .rider-memo-one-title{
      font-size: 14px;
      font-weight: 700;
    }
    .rider-memo-one-note{
      font-size: 12px;
      color:#666;
    }
    .rider-memo-one-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .rm-label{
      font-size: 12px;
      font-weight: 600;
    }
    .rm-name{
      width: 260px;
      max-width: 100%;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .rm-text{
      width: 100%;
      min-height: 110px;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
      box-sizing: border-box;
    }
    .rider-memo-one-actions{
      margin-top: 8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>

  <h1>ç«¶è¼ª äºˆæƒ³ãƒœãƒ¼ãƒ‰ï¼ˆè¿½éšç‰ˆï¼‰</h1>
  <div class="version-box">ver 1.3.1ï¼ˆå‡ºèµ°ãƒã‚§ãƒƒã‚¯ï¼‹é¸æ‰‹ãƒ¡ãƒ¢èª­è¾¼äº’æ›ï¼‰</div>

  <div class="author-box">
    ğŸ‰ ä½œè€…Xï¼ˆTwitterï¼‰ï¼š
    <a href="https://x.com/kumatarou_kuma_" target="_blank">@kumatarou_kuma_</a>
  </div>

  <!-- â–¼ ç«¶è¼ªå ´é¸æŠï¼‹ç‰¹å¾´è¡¨ç¤º -->
  <div class="bank-box">
    <label for="bank-select">ãƒãƒ³ã‚¯ï¼š</label>
    <select id="bank-select">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>

      <optgroup label="åŒ—æ—¥æœ¬">
        <option value="hakodate">å‡½é¤¨</option>
        <option value="aomori">é’æ£®</option>
        <option value="iwakidaira">ã„ã‚ãå¹³</option>
      </optgroup>

      <optgroup label="é–¢æ±">
        <option value="yahiko">å¼¥å½¦</option>
        <option value="maebashi">å‰æ©‹</option>
        <option value="toride">å–æ‰‹</option>
        <option value="utsunomiya">å®‡éƒ½å®®</option>
        <option value="omiya">å¤§å®®</option>
        <option value="seibuen">è¥¿æ­¦åœ’</option>
        <option value="keio">äº¬ç‹é–£</option>
        <option value="tachikawa">ç«‹å·</option>
      </optgroup>

      <optgroup label="å—é–¢æ±">
        <option value="matsudo">æ¾æˆ¸</option>
        <option value="chiba">åƒè‘‰ï¼ˆ250ï¼‰</option>
        <option value="kawasaki">å·å´</option>
        <option value="hiratsuka">å¹³å¡š</option>
        <option value="odawara">å°ç”°åŸ</option>
        <option value="ito">ä¼Šæ±</option>
        <option value="shizuoka">é™å²¡</option>
      </optgroup>

      <optgroup label="ä¸­éƒ¨">
        <option value="nagoya">åå¤å±‹</option>
        <option value="gifu">å²é˜œ</option>
        <option value="ogaki">å¤§å£</option>
        <option value="toyohashi">è±Šæ©‹</option>
        <option value="toyama">å¯Œå±±</option>
        <option value="matsusaka">æ¾é˜ª</option>
        <option value="yokkaichi">å››æ—¥å¸‚</option>
      </optgroup>

      <optgroup label="è¿‘ç•¿">
        <option value="fukui">ç¦äº•</option>
        <option value="nara">å¥ˆè‰¯</option>
        <option value="muko">å‘æ—¥ç”º</option>
        <option value="wakayama">å’Œæ­Œå±±</option>
        <option value="kishiwada">å²¸å’Œç”°</option>
      </optgroup>

      <optgroup label="ä¸­å›½">
        <option value="tamano">ç‰é‡</option>
        <option value="hiroshima">åºƒå³¶</option>
        <option value="hofu">é˜²åºœ</option>
      </optgroup>

      <optgroup label="å››å›½">
        <option value="takamatsu">é«˜æ¾</option>
        <option value="komatsushima">å°æ¾å³¶</option>
        <option value="kochi">é«˜çŸ¥</option>
        <option value="matsuyama">æ¾å±±</option>
      </optgroup>

      <optgroup label="ä¹å·">
        <option value="kokura">å°å€‰</option>
        <option value="kurume">ä¹…ç•™ç±³</option>
        <option value="takeo">æ­¦é›„</option>
        <option value="sasebo">ä½ä¸–ä¿</option>
        <option value="beppu">åˆ¥åºœ</option>
        <option value="kumamoto">ç†Šæœ¬</option>
      </optgroup>
    </select>

    <div class="bank-info">
      <div class="bank-name-display" id="bank-name-display">ãƒãƒ³ã‚¯æœªé¸æŠ</div>
      <div id="bank-type-display">
        <span class="bank-tag">ã‚¿ã‚¤ãƒ— -</span>
      </div>
      <div id="bank-feature-display">ç‰¹å¾´ï¼š-</div>
    </div>
  </div>
  <!-- â–² ç«¶è¼ªå ´é¸æŠï¼‹ç‰¹å¾´è¡¨ç¤º -->

  <!-- â–¼ å‡ºèµ°è»Šç•ªãƒã‚§ãƒƒã‚¯ -->
  <div class="line-inputs" id="rider-checks">
    <div class="line-inputs-title">å‡ºèµ°è»Šç•ªï¼ˆãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ä¸¸ã‚’éè¡¨ç¤ºï¼‰</div>
    <div class="line-row-group" id="rider-checks-row"></div>
    <div class="line-row-button">
      <button class="btn" id="presetAllOn">å…¨ON</button>
      <button class="btn" id="presetAllOff">å…¨OFF</button>
      <button class="btn" id="preset7">7è»Šï¼ˆ1ã€œ7ï¼‰</button>
      <button class="btn" id="preset8">8è»Šï¼ˆ1ã€œ8ï¼‰</button>
      <button class="btn" id="preset9">9è»Šï¼ˆ1ã€œ9ï¼‰</button>
    </div>
  </div>

  <!-- â–¼ ãƒ©ã‚¤ãƒ³ç°¡æ˜“å…¥åŠ› -->
  <div class="line-inputs">
    <div class="line-inputs-title">
      ãƒ©ã‚¤ãƒ³ç°¡æ˜“å…¥åŠ›ï¼ˆä¾‹ï¼š<code>1.3.5</code> / <code>2,4,7</code> / <code>3 6 9</code>ï¼‰
    </div>
    <div class="line-row-group">
      <div class="line-row"><label for="line-g1">G1ï¼š</label><input id="line-g1" placeholder="1.3.5"></div>
      <div class="line-row"><label for="line-g2">G2ï¼š</label><input id="line-g2" placeholder="2.6.9"></div>
      <div class="line-row"><label for="line-g3">G3ï¼š</label><input id="line-g3" placeholder="4.7"></div>
      <div class="line-row"><label for="line-g4">G4ï¼š</label><input id="line-g4" placeholder=""></div>
      <div class="line-row"><label for="line-g5">G5ï¼š</label><input id="line-g5" placeholder=""></div>
    </div>
    <div class="line-row-button">
      <button class="btn" id="applyLinesBtn">ãƒ©ã‚¤ãƒ³åæ˜ ï¼ˆè¿½éšãƒ©ã‚¤ãƒ³ã‚’ä¸€æ‹¬ã‚»ãƒƒãƒˆï¼‰</button>
    </div>
  </div>

  <div class="controls">
    <button class="btn" id="resetBtn">åˆæœŸä½ç½®ã«æˆ»ã™</button>
    <button class="btn" id="clearSelectionBtn">ãƒ©ã‚¤ãƒ³é¸æŠè§£é™¤</button>

    <button class="btn btn-size btn-size-active" data-size="small">ä¸¸ å°</button>
    <button class="btn btn-size" data-size="medium">ä¸¸ ä¸­</button>
    <button class="btn btn-size" data-size="large">ä¸¸ å¤§</button>

    <button class="btn group-mode-btn" data-group="1">G1</button>
    <button class="btn group-mode-btn" data-group="2">G2</button>
    <button class="btn group-mode-btn" data-group="3">G3</button>
    <button class="btn group-mode-btn" data-group="4">G4</button>
    <button class="btn group-mode-btn" data-group="5">G5</button>
    <button class="btn" id="clearGroupsBtn">å…¨è§£é™¤</button>
  </div>

  <div class="board-wrapper">
    <div class="track" id="track">
      <div class="rider r1">1</div>
      <div class="rider r2">2</div>
      <div class="rider r3">3</div>
      <div class="rider r4">4</div>
      <div class="rider r5">5</div>
      <div class="rider r6">6</div>
      <div class="rider r7">7</div>
      <div class="rider r8">8</div>
      <div class="rider r9">9</div>
    </div>
  </div>

  <div class="hint">
    â— å‡ºèµ°è»Šç•ªãƒã‚§ãƒƒã‚¯ â†’ 7è»Šç«‹ã¦ç­‰ã«å¯¾å¿œï¼ˆå¤–ã™ã¨éè¡¨ç¤ºï¼‰<br>
    â— G1ã€œG5 â†’ ã‚¿ãƒƒãƒ—ã§æ‰€å±å¤‰æ›´ï¼ä¸Šã®å…¥åŠ›æ¬„ã‹ã‚‰ä¸€æ‹¬è¨­å®šã‚‚å¯<br>
    â— è¿½éšç‰ˆï¼šã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã£ãŸä¸¸ã¯ãƒãƒ³ã‚¯ã«æ²¿ã£ã¦ãƒ©ã‚¤ãƒ³ã”ã¨ã«ã‚¹ãƒ«ãƒƒã¨ç§»å‹•<br>
    â— ã€Œãƒ©ã‚¤ãƒ³åæ˜ ã€ã§å„ãƒ©ã‚¤ãƒ³ãŒãƒãƒ³ã‚¯ä¸Šã®ä½ç½®ã«â€œã„ã„æ„Ÿã˜ã®è»Šé–“â€ã§æ•´åˆ—ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚‚è»Šé–“å›ºå®šï¼‰<br>
    â— è²·ç›®ã‚„äºˆæƒ³ã€æ°—ã«ãªã‚‹ã“ã¨ã‚’ãƒ¡ãƒ¢ã¨ã—ã¦æ®‹ã›ã‚‹ãƒ»ä¿å­˜ã‚’æŠ¼ã›ã°é–‰ã˜ã¦ã‚‚æ¶ˆãˆãªã„
  </div>

  <!-- âœ… é †ç•ªå›ºå®šï¼šåºƒå‘Š â†’ ãƒ¡ãƒ¢ â†’ é¸æ‰‹ãƒ¡ãƒ¢ -->

  <!-- åºƒå‘Š -->
  <div class="ads-multi">
    <div class="ad-item">
      <div class="ad-title">PRï¼šç„¡æ–™ä¼šå“¡ç™»éŒ²</div>

      <a href="https://px.a8.net/svt/ejp?a8mat=45ILCW+BQPSAA+4V0K+5YRHE" rel="nofollow">
        ç„¡æ–™ä¼šå“¡ç™»éŒ²ã§æœ€å¤§3000å††åˆ†ã‚‚ã‚‰ãˆã‚‹
      </a>
      <br>

      <a href="https://x.com/kumatarou_kuma_" target="_blank" rel="nofollow" style="font-size:12px;">
        ã€åºƒå‘Šå‹Ÿé›†ä¸­ã€‘
      </a>

      <img border="0" width="1" height="1"
           src="https://www14.a8.net/0.gif?a8mat=45ILCW+BQPSAA+4V0K+5YRHE"
           alt="">
    </div>
  </div>

  <!-- ãƒ¡ãƒ¢ -->
  <div class="memo-wrapper">
    <div class="memo-title">ğŸ“ ãƒ¡ãƒ¢ï¼ˆã“ã®ç«¯æœ«ã ã‘ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰</div>
    <textarea id="memo" placeholder="ãƒ©ã‚¤ãƒ³æ§‹æˆã€å±•é–‹äºˆæƒ³ã€ã‚³ãƒ¡ãƒ³ãƒˆãªã©è‡ªç”±ã«ãƒ¡ãƒ¢ã§ãã¾ã™ã€‚"></textarea>
    <div class="memo-buttons">
      <button class="btn" id="saveMemoBtn">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
      <button class="btn" id="clearMemoBtn">ãƒ¡ãƒ¢ã‚’æ¶ˆå»</button>
    </div>
  </div>

  <!-- é¸æ‰‹ãƒ¡ãƒ¢ï¼ˆ1äººåˆ†ï¼‰ -->
  <div class="rider-memo-one">
    <div class="rider-memo-one-head">
      <div class="rider-memo-one-title">é¸æ‰‹ãƒ¡ãƒ¢ï¼ˆ1äººåˆ†ï¼‰</div>
      <div class="rider-memo-one-note">
        9äººãƒ¡ãƒ¢ã¨åŒã˜ã€ŒriderMemoã€åå‰ã§å…±æœ‰ã€‚é¸æ‰‹åã‚’å…¥ã‚Œã¦èª­è¾¼/ä¿å­˜ã§ãã¾ã™
      </div>
    </div>

    <div class="rider-memo-one-row">
      <label class="rm-label" for="rm-name">é¸æ‰‹åï¼š</label>
      <input id="rm-name" class="rm-name" placeholder="ä¾‹ï¼šè„‡æœ¬é›„å¤ª">
      <button class="btn" id="rm-load">èª­è¾¼</button>
    </div>

    <textarea id="rm-text" class="rm-text"
      placeholder="ã“ã®é¸æ‰‹ã®è„šè³ªãƒ»ã‚¯ã‚»ãƒ»éå»ã®å°è±¡ãªã©è‡ªç”±ã«ãƒ¡ãƒ¢ã§ãã¾ã™ï¼ˆ9äººãƒ¡ãƒ¢ã¨å…±é€šï¼‰ã€‚"></textarea>

    <div class="rider-memo-one-actions">
      <button class="btn" id="rm-save">ä¿å­˜</button>
      <button class="btn" id="rm-paste">â†‘ä¸Šã®ãƒ¡ãƒ¢æ¬„ã¸è²¼ã‚Šä»˜ã‘</button>
      <button class="btn" id="rm-delete">å‰Šé™¤</button>
    </div>
  </div>

<script>
(function () {
  const track = document.getElementById("track");
  const riders = Array.from(document.querySelectorAll(".rider"));
  const resetBtn = document.getElementById("resetBtn");
  const clearSelectionBtn = document.getElementById("clearSelectionBtn");
  const sizeButtons = Array.from(document.querySelectorAll(".btn-size"));
  const groupButtons = Array.from(document.querySelectorAll(".group-mode-btn"));
  const clearGroupsBtn = document.getElementById("clearGroupsBtn");

  const memo = document.getElementById("memo");
  const saveMemoBtn = document.getElementById("saveMemoBtn");
  const clearMemoBtn = document.getElementById("clearMemoBtn");
  const MEMO_KEY = "keirin-board-memo-v1";

  /* â–¼ ãƒ©ã‚¤ãƒ³ç°¡æ˜“å…¥åŠ›DOM */
  const applyLinesBtn = document.getElementById("applyLinesBtn");
  const lineInputs = {
    1: document.getElementById("line-g1"),
    2: document.getElementById("line-g2"),
    3: document.getElementById("line-g3"),
    4: document.getElementById("line-g4"),
    5: document.getElementById("line-g5"),
  };
  let lineConfig = {1:[],2:[],3:[],4:[],5:[]};

  // âœ… ã‚¿ãƒƒãƒ—é †ã‚’ä¿æŒï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ï¼‰
  let groupTapOrder = {1:[],2:[],3:[],4:[],5:[]};

  function pushUnique(arr, num){
    const i = arr.indexOf(num);
    if (i >= 0) arr.splice(i, 1);
    arr.push(num);
  }
  function removeItem(arr, num){
    const i = arr.indexOf(num);
    if (i >= 0) arr.splice(i, 1);
  }

  /* â–¼ å‡ºèµ°è»Šç•ªãƒã‚§ãƒƒã‚¯DOM */
  const riderChecksRow = document.getElementById("rider-checks-row");
  const presetAllOn  = document.getElementById("presetAllOn");
  const presetAllOff = document.getElementById("presetAllOff");
  const preset7 = document.getElementById("preset7");
  const preset8 = document.getElementById("preset8");
  const preset9 = document.getElementById("preset9");
  let enabledNums = new Set([1,2,3,4,5,6,7,8,9]);

  /* â–¼ é¸æ‰‹ãƒ¡ãƒ¢ï¼ˆ1äººåˆ†ï¼‰DOM */
  const rmName  = document.getElementById("rm-name");
  const rmText  = document.getElementById("rm-text");
  const rmLoad  = document.getElementById("rm-load");
  const rmSave  = document.getElementById("rm-save");
  const rmPaste = document.getElementById("rm-paste");
  const rmDelete= document.getElementById("rm-delete");
  const RIDER_MEMO_KEY = "riderMemo";

  /* â–¼ ãƒãƒ³ã‚¯é–¢é€£DOM */
  const bankSelect        = document.getElementById("bank-select");
  const bankNameDisplay   = document.getElementById("bank-name-display");
  const bankTypeDisplay   = document.getElementById("bank-type-display");
  const bankFeatureDisplay= document.getElementById("bank-feature-display");

  let isDragging = false;
  let dragItems = [];
  let didDrag = false;

  const BASE_SIZE = 52;
  let currentGroupMode = null;

  const ANGLE_SPACING = 0.12;

  // =========================================================
  // â˜…è¿½åŠ ï¼šå¸¸æ™‚ã€Œå¼§é•·ï¼ˆãƒãƒ³ã‚¯ä¸Šã®è·é›¢ï¼‰ã€ã§ç­‰é–“éš”ã«ã™ã‚‹ãŸã‚ã®é–¢æ•°ç¾¤
  // =========================================================
  let arcTable = null; // { N, angles[], lens[], total }

  function normAngle0to2pi(a){
    const t = Math.PI * 2;
    a = a % t;
    if (a < 0) a += t;
    return a;
  }

  function buildArcTable(N = 2048){
    const tMax = Math.PI * 2;
    const dt = tMax / N;

    const angles = new Array(N + 1);
    const lens   = new Array(N + 1);
    angles[0] = 0;
    lens[0] = 0;

    for (let i = 1; i <= N; i++){
      const t = i * dt;
      angles[i] = t;

      // ds/dt = sqrt((rx*sin t)^2 + (ry*cos t)^2) * baseRadiusScale
      const s = Math.hypot(ellipseRx * Math.sin(t), ellipseRy * Math.cos(t)) * baseRadiusScale;
      lens[i] = lens[i - 1] + s * dt;
    }
    return { N, angles, lens, total: lens[N] };
  }

  function lengthAtAngle(angle){
    if (!arcTable) return 0;
    const a = normAngle0to2pi(angle);

    const tMax = Math.PI * 2;
    const x = a / tMax * arcTable.N;
    const i = Math.floor(x);
    const f = x - i;

    const L0 = arcTable.lens[i];
    const L1 = arcTable.lens[i + 1];
    return L0 + (L1 - L0) * f;
  }

  function angleAtLength(len){
    if (!arcTable) return 0;
    const total = arcTable.total;

    let L = len % total;
    if (L < 0) L += total;

    const arr = arcTable.lens;
    let lo = 0, hi = arr.length - 1;
    while (lo + 1 < hi){
      const mid = (lo + hi) >> 1;
      if (arr[mid] <= L) lo = mid;
      else hi = mid;
    }

    const L0 = arr[lo], L1 = arr[hi];
    const t0 = arcTable.angles[lo], t1 = arcTable.angles[hi];
    const f = (L1 - L0) ? (L - L0) / (L1 - L0) : 0;
    return t0 + (t1 - t0) * f;
  }

  function getSpacingPx(){
    // ä¸¸ã‚µã‚¤ã‚ºã«è¿½éšã—ã¦è»Šé–“ã‚’æ±ºã‚ã‚‹ï¼ˆå¥½ã¿ã§ä¿‚æ•°ã ã‘èª¿æ•´ï¼‰
    const any = riders.find(r => r.style.display !== "none") || riders[0];
    const w = any ? (any.offsetWidth || 52) : 52;
    return Math.max(40, w * 0.80); // â† ã“ã“ã‚’ 1.05ã€œ1.20 ã§å¥½ã¿èª¿æ•´
  }
  // =========================================================

  let ellipseCenterX = 0;
  let ellipseCenterY = 0;
  let ellipseRx = 0;
  let ellipseRy = 0;
  let baseRadiusScale = 1;
  let dragPointerAngle0 = 0;

  const DRAG_SENSITIVITY = 0.8;

  const bankMaster = {
    hakodate:  { name: "å‡½é¤¨",   fullName: "å‡½é¤¨ç«¶è¼ªå ´",     region: "åŒ—æ—¥æœ¬", length: 400 },
    aomori:    { name: "é’æ£®",   fullName: "é’æ£®ç«¶è¼ªå ´",     region: "åŒ—æ—¥æœ¬", length: 400 },
    iwakidaira:{ name: "ã„ã‚ãå¹³", fullName: "ã„ã‚ãå¹³ç«¶è¼ªå ´", region: "åŒ—æ—¥æœ¬", length: 400 },

    yahiko:    { name: "å¼¥å½¦",   fullName: "å¼¥å½¦ç«¶è¼ªå ´",     region: "é–¢æ±",   length: 400 },
    maebashi:  { name: "å‰æ©‹",   fullName: "å‰æ©‹ç«¶è¼ªå ´",     region: "é–¢æ±",   length: 335 },
    toride:    { name: "å–æ‰‹",   fullName: "å–æ‰‹ç«¶è¼ªå ´",     region: "é–¢æ±",   length: 400 },
    utsunomiya:{ name: "å®‡éƒ½å®®", fullName: "å®‡éƒ½å®®ç«¶è¼ªå ´",   region: "é–¢æ±",   length: 500 },
    omiya:     { name: "å¤§å®®",   fullName: "å¤§å®®ç«¶è¼ªå ´",     region: "é–¢æ±",   length: 500 },
    seibuen:   { name: "è¥¿æ­¦åœ’", fullName: "è¥¿æ­¦åœ’ç«¶è¼ªå ´",   region: "é–¢æ±",   length: 400 },
    keio:      { name: "äº¬ç‹é–£", fullName: "äº¬ç‹é–£ç«¶è¼ªå ´",   region: "é–¢æ±",   length: 400 },
    tachikawa: { name: "ç«‹å·",   fullName: "ç«‹å·ç«¶è¼ªå ´",     region: "é–¢æ±",   length: 400 },

    matsudo:   { name: "æ¾æˆ¸",   fullName: "æ¾æˆ¸ç«¶è¼ªå ´",     region: "å—é–¢æ±", length: 333 },
    chiba:     { name: "åƒè‘‰",   fullName: "åƒè‘‰ç«¶è¼ªå ´ï¼ˆPIST6ï¼‰", region: "å—é–¢æ±", length: 250 },
    kawasaki:  { name: "å·å´",   fullName: "å·å´ç«¶è¼ªå ´",     region: "å—é–¢æ±", length: 400 },
    hiratsuka: { name: "å¹³å¡š",   fullName: "å¹³å¡šç«¶è¼ªå ´",     region: "å—é–¢æ±", length: 400 },
    odawara:   { name: "å°ç”°åŸ", fullName: "å°ç”°åŸç«¶è¼ªå ´",   region: "å—é–¢æ±", length: 333 },
    ito:       { name: "ä¼Šæ±",   fullName: "ä¼Šæ±æ¸©æ³‰ç«¶è¼ªå ´", region: "å—é–¢æ±", length: 333 },
    shizuoka:  { name: "é™å²¡",   fullName: "é™å²¡ç«¶è¼ªå ´",     region: "å—é–¢æ±", length: 400 },

    nagoya:    { name: "åå¤å±‹", fullName: "åå¤å±‹ç«¶è¼ªå ´",   region: "ä¸­éƒ¨",   length: 400 },
    gifu:      { name: "å²é˜œ",   fullName: "å²é˜œç«¶è¼ªå ´",     region: "ä¸­éƒ¨",   length: 400 },
    ogaki:     { name: "å¤§å£",   fullName: "å¤§å£ç«¶è¼ªå ´",     region: "ä¸­éƒ¨",   length: 400 },
    toyohashi: { name: "è±Šæ©‹",   fullName: "è±Šæ©‹ç«¶è¼ªå ´",     region: "ä¸­éƒ¨",   length: 400 },
    toyama:    { name: "å¯Œå±±",   fullName: "å¯Œå±±ç«¶è¼ªå ´",     region: "ä¸­éƒ¨",   length: 333 },
    matsusaka: { name: "æ¾é˜ª",   fullName: "æ¾é˜ªç«¶è¼ªå ´",     region: "ä¸­éƒ¨",   length: 400 },
    yokkaichi: { name: "å››æ—¥å¸‚", fullName: "å››æ—¥å¸‚ç«¶è¼ªå ´",   region: "ä¸­éƒ¨",   length: 400 },

    fukui:     { name: "ç¦äº•",   fullName: "ç¦äº•ç«¶è¼ªå ´",     region: "è¿‘ç•¿",   length: 400 },
    nara:      { name: "å¥ˆè‰¯",   fullName: "å¥ˆè‰¯ç«¶è¼ªå ´",     region: "è¿‘ç•¿",   length: 333 },
    muko:      { name: "å‘æ—¥ç”º", fullName: "å‘æ—¥ç”ºç«¶è¼ªå ´",   region: "è¿‘ç•¿",   length: 400 },
    wakayama:  { name: "å’Œæ­Œå±±", fullName: "å’Œæ­Œå±±ç«¶è¼ªå ´",   region: "è¿‘ç•¿",   length: 400 },
    kishiwada: { name: "å²¸å’Œç”°", fullName: "å²¸å’Œç”°ç«¶è¼ªå ´",   region: "è¿‘ç•¿",   length: 400 },

    tamano:    { name: "ç‰é‡",   fullName: "ç‰é‡ç«¶è¼ªå ´",     region: "ä¸­å›½",   length: 400 },
    hiroshima: { name: "åºƒå³¶",   fullName: "åºƒå³¶ç«¶è¼ªå ´",     region: "ä¸­å›½",   length: 400 },
    hofu:      { name: "é˜²åºœ",   fullName: "é˜²åºœç«¶è¼ªå ´",     region: "ä¸­å›½",   length: 333 },

    takamatsu:    { name: "é«˜æ¾",   fullName: "é«˜æ¾ç«¶è¼ªå ´",     region: "å››å›½",   length: 400 },
    komatsushima: { name: "å°æ¾å³¶", fullName: "å°æ¾å³¶ç«¶è¼ªå ´",   region: "å››å›½",   length: 400 },
    kochi:        { name: "é«˜çŸ¥",   fullName: "é«˜çŸ¥ç«¶è¼ªå ´",     region: "å››å›½",   length: 500 },
    matsuyama:    { name: "æ¾å±±",   fullName: "æ¾å±±ç«¶è¼ªå ´",     region: "å››å›½",   length: 400 },

    kokura:   { name: "å°å€‰",   fullName: "å°å€‰ç«¶è¼ªå ´",     region: "ä¹å·",   length: 400 },
    kurume:   { name: "ä¹…ç•™ç±³", fullName: "ä¹…ç•™ç±³ç«¶è¼ªå ´",   region: "ä¹å·",   length: 400 },
    takeo:    { name: "æ­¦é›„",   fullName: "æ­¦é›„ç«¶è¼ªå ´",     region: "ä¹å·",   length: 400 },
    sasebo:   { name: "ä½ä¸–ä¿", fullName: "ä½ä¸–ä¿ç«¶è¼ªå ´",   region: "ä¹å·",   length: 400 },
    beppu:    { name: "åˆ¥åºœ",   fullName: "åˆ¥åºœç«¶è¼ªå ´",     region: "ä¹å·",   length: 400 },
    kumamoto: { name: "ç†Šæœ¬",   fullName: "ç†Šæœ¬ç«¶è¼ªå ´",     region: "ä¹å·",   length: 400 }
  };

  const lengthProfiles = {
    333: { tag: "33ãƒãƒ³ã‚¯",  type: "å…ˆè¡Œãƒ»é€ƒã’æœ‰åˆ©",        feature: "ã‚³ãƒ¼ãƒŠãƒ¼ãŒå¤šãç›´ç·šãŒçŸ­ã‚ã€‚é€ƒã’ãƒ»å…ˆè¡Œã®æŠ¼ã—åˆ‡ã‚Šã‚„æ³¢ä¹±ã‚‚å‡ºã‚„ã™ã„ãƒãƒ³ã‚¯ã€‚" },
    335: { tag: "335ãƒãƒ³ã‚¯", type: "ã‚«ãƒ³ãƒˆå¼·ã‚ã®è‡ªåŠ›å‹è² ",    feature: "ã‚«ãƒ³ãƒˆãŒãã¤ã‚ã§è¸ã¿ç›´ã—ãŒåˆ©ãã‚¿ã‚¤ãƒ—ã€‚è‡ªåŠ›å‹ã®è¸ã¿åˆã„ã«ãªã‚Šã‚„ã™ã„ã€‚" },
    400: { tag: "400ãƒãƒ³ã‚¯", type: "æ¨™æº–çš„ãªãƒãƒ©ãƒ³ã‚¹å‹",      feature: "å…¨å›½æ¨™æº–ã®è·é›¢ã§ã‚¯ã‚»ãŒå°‘ãªã„ã€‚ãƒ©ã‚¤ãƒ³æ±ºç€ãƒ»ç•ªæ‰‹å·®ã—ãƒ»æ²ã‚ŠãŒãƒãƒ©ãƒ³ã‚¹ã‚ˆãæ±ºã¾ã‚Šã‚„ã™ã„ã€‚" },
    500: { tag: "500ãƒãƒ³ã‚¯", type: "ç›´ç·šé•·ã‚ãƒ»å·®ã—å¯„ã‚Š",      feature: "ç›´ç·šãŒé•·ãã€é€ƒã’æ®‹ã‚Šã‚ˆã‚Šã‚‚æ²ã‚Šãƒ»å·®ã—ãŒå±Šãã‚„ã™ã„å‚¾å‘ã®ãƒ­ãƒ³ã‚°ãƒãƒ³ã‚¯ã€‚" },
    250: { tag: "250æœ¨è£½ãƒ‰ãƒ¼ãƒ ", type: "ã‚¹ãƒ—ãƒªãƒ³ãƒˆç‰¹åŒ–",    feature: "åƒè‘‰ã®å±‹å†…æœ¨è£½ãƒãƒ³ã‚¯ã€‚å‘¨é•·ãŒçŸ­ãå‘¨å›æ•°ãŒå¤šã„ã‚¹ãƒ—ãƒªãƒ³ãƒˆå¿—å‘ã®ãƒ¬ãƒ¼ã‚¹ãŒä¸­å¿ƒã€‚" }
  };

  const numToEl = {};
  riders.forEach(r => {
    const n = parseInt(r.textContent.trim(), 10);
    if (!isNaN(n)) numToEl[n] = r;
  });

  function initRail() {
    const rect = track.getBoundingClientRect();
    ellipseCenterX = rect.width / 2;
    ellipseCenterY = rect.height / 2;

    const baseRx = rect.width  * 0.40;
    const baseRy = rect.height * 0.43;

    const r6 = document.querySelector(".r6");
    if (!r6) return;

    const r6Rect = r6.getBoundingClientRect();
    const r6cx = (r6Rect.left - rect.left) + r6Rect.width / 2;
    const r6cy = (r6Rect.top  - rect.top)  + r6Rect.height / 2;

    const dx = r6cx - ellipseCenterX;
    const dy = r6cy - ellipseCenterY;
    const angle = Math.atan2(dy, dx);

    const idealRx = baseRx * Math.cos(angle);
    const idealRy = baseRy * Math.sin(angle);
    const idealR  = Math.hypot(idealRx, idealRy) || 1;
    const actualR = Math.hypot(dx, dy);

    baseRadiusScale = actualR / idealR;
    ellipseRx = baseRx;
    ellipseRy = baseRy;

    // â˜…è¿½åŠ ï¼šå¼§é•·ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆï¼ˆå¸¸æ™‚ã€å‡ç­‰è»Šé–“ï¼‰
    arcTable = buildArcTable(2048);
  }

  function applySize(mode) {
    let scale;
    if (mode === "small") scale = 0.80;
    else if (mode === "large") scale = 1.25;
    else scale = 1.0;

    const newSize = BASE_SIZE * scale;
    riders.forEach(r => {
      r.style.width = newSize + "px";
      r.style.height = newSize + "px";
      r.style.fontSize = (newSize * 0.5) + "px";
    });

    sizeButtons.forEach(b => b.classList.remove("btn-size-active"));
    const active = sizeButtons.find(b => b.dataset.size === mode);
    if (active) active.classList.add("btn-size-active");
  }
  sizeButtons.forEach(btn => btn.addEventListener("click", () => applySize(btn.dataset.size)));

  function updateGroupButtonStates() {
    groupButtons.forEach(btn => {
      btn.classList.toggle("btn-group-active", btn.dataset.group === currentGroupMode);
    });
  }
  groupButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const g = btn.dataset.group;
      currentGroupMode = (currentGroupMode === g ? null : g);
      updateGroupButtonStates();
    });
  });

  clearGroupsBtn.addEventListener("click", () => {
    currentGroupMode = null;
    updateGroupButtonStates();
    riders.forEach(r => delete r.dataset.group);
    lineConfig = {1:[],2:[],3:[],4:[],5:[]};
    groupTapOrder = {1:[],2:[],3:[],4:[],5:[]};
  });

  function selectedRiders() {
    return riders.filter(r => r.classList.contains("selected"));
  }

  function normalizeAngleDiff(diff) {
    while (diff > Math.PI)  diff -= Math.PI * 2;
    while (diff < -Math.PI) diff += Math.PI * 2;
    return diff;
  }

  /* â–¼ å‡ºèµ°ãƒã‚§ãƒƒã‚¯ */
  function renderRiderChecks() {
    riderChecksRow.innerHTML = "";
    for (let n = 1; n <= 9; n++) {
      const label = document.createElement("label");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = enabledNums.has(n);
      cb.dataset.num = String(n);

      cb.addEventListener("change", () => {
        const num = parseInt(cb.dataset.num, 10);
        if (cb.checked) enabledNums.add(num);
        else enabledNums.delete(num);

        applyEnabledNums();
        applyLinesFromInputs();
      });

      const span = document.createElement("span");
      span.textContent = String(n);

      label.appendChild(cb);
      label.appendChild(span);
      riderChecksRow.appendChild(label);
    }
  }

  function applyEnabledNums() {
    for (let n = 1; n <= 9; n++) {
      const el = numToEl[n];
      if (!el) continue;

      const on = enabledNums.has(n);
      el.style.display = on ? "" : "none";

      if (!on) {
        el.classList.remove("selected");
        if (el.dataset.group) {
          const g = parseInt(el.dataset.group, 10);
          removeItem(groupTapOrder[g], n);
        }
        delete el.dataset.group;
      }
    }
  }

  function setEnabledRange(maxN) {
    enabledNums = new Set();
    for (let n = 1; n <= maxN; n++) enabledNums.add(n);
    renderRiderChecks();
    applyEnabledNums();
    applyLinesFromInputs();
  }

  presetAllOn.addEventListener("click", () => {
    enabledNums = new Set([1,2,3,4,5,6,7,8,9]);
    renderRiderChecks();
    applyEnabledNums();
    applyLinesFromInputs();
  });

  presetAllOff.addEventListener("click", () => {
    enabledNums = new Set();
    renderRiderChecks();
    applyEnabledNums();
    applyLinesFromInputs();
  });

  preset7.addEventListener("click", () => setEnabledRange(7));
  preset8.addEventListener("click", () => setEnabledRange(8));
  preset9.addEventListener("click", () => setEnabledRange(9));
  /* â–² å‡ºèµ°ãƒã‚§ãƒƒã‚¯ */

  /* â–¼ ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å¤‰æ›´ or è¤‡æ•°é¸æŠï¼‰ */
  track.addEventListener("click", (e) => {
    if (didDrag) {
      didDrag = false;
      return;
    }

    const r = e.target.closest(".rider");
    if (!r) return;
    if (r.style.display === "none") return;

    if (currentGroupMode) {
      const g = parseInt(currentGroupMode, 10);
      const n = parseInt(r.textContent.trim(), 10);

      if (r.dataset.group === currentGroupMode) {
        delete r.dataset.group;
        if (!isNaN(n)) removeItem(groupTapOrder[g], n);
      } else {
        if (r.dataset.group) {
          const oldG = parseInt(r.dataset.group, 10);
          if (!isNaN(n)) removeItem(groupTapOrder[oldG], n);
        }
        r.dataset.group = currentGroupMode;
        if (!isNaN(n)) pushUnique(groupTapOrder[g], n);
      }
      return;
    }

    if (e.shiftKey) r.classList.toggle("selected");
  });

  /* â–¼ ãƒ©ã‚¤ãƒ³ï¼šæ–‡å­—åˆ—â†’é…åˆ—ï¼ˆéè¡¨ç¤ºè»Šç•ªé™¤å¤–ï¼‰ */
  function parseLine(str) {
    if (!str) return [];
    return str
      .split(/[^\d]+/)
      .filter(Boolean)
      .map(n => parseInt(n,10))
      .filter(n => !isNaN(n) && numToEl[n] && enabledNums.has(n));
  }

  function applyLinesFromInputs() {
    riders.forEach(r => delete r.dataset.group);
    lineConfig = {1:[],2:[],3:[],4:[],5:[]};

    const rect = track.getBoundingClientRect();

    const baseAngles = {
      1: -Math.PI * 0.45,
      2: -Math.PI * 0.35,
      3: -Math.PI * 0.25,
      4: -Math.PI * 0.15,
      5: -Math.PI * 0.05
    };

    for (let g = 1; g <= 5; g++) {
      const input = lineInputs[g];
      if (!input) continue;

      const typed = parseLine(input.value);
      const tapped = (groupTapOrder[g] || []).filter(n => enabledNums.has(n) && numToEl[n]);
      const arr = tapped.length ? tapped : typed;

      lineConfig[g] = arr;
      if (arr.length === 0) continue;

      const baseAngle = baseAngles[g] ?? (-Math.PI * 0.25);
      const count = arr.length;
      const offsetStart = -(count - 1) / 2;

      // â˜…è¿½åŠ ï¼šè»Šé–“ï¼ˆpxï¼‰ã‚’ä¸¸ã‚µã‚¤ã‚ºã«è¿½éšã•ã›ã‚‹
      const spacingPx = getSpacingPx();
      const baseLen = lengthAtAngle(baseAngle);

      arr.forEach((num, idx) => {
        const el = numToEl[num];
        if (!el) return;

        el.dataset.group = String(g);

        const offsetIndex = offsetStart + idx;

        // â˜…å¤‰æ›´ï¼šè§’åº¦ç­‰é–“éš”ã§ã¯ãªãã€Œå¼§é•·ï¼ˆè·é›¢ï¼‰ç­‰é–“éš”ã€
        const targetLen = baseLen + offsetIndex * spacingPx;
        const angle = angleAtLength(targetLen);

        const ex = ellipseCenterX + Math.cos(angle) * ellipseRx * baseRadiusScale;
        const ey = ellipseCenterY + Math.sin(angle) * ellipseRy * baseRadiusScale;

        const w = el.offsetWidth  || 52;
        const h = el.offsetHeight || 52;

        let left = ex - w / 2;
        let top  = ey - h / 2;

        const maxX = rect.width  - w;
        const maxY = rect.height - h;

        left = Math.max(0, Math.min(maxX, left));
        top  = Math.max(0, Math.min(maxY, top));

        el.style.left = left + "px";
        el.style.top  = top  + "px";
      });
    }
  }
  applyLinesBtn.addEventListener("click", applyLinesFromInputs);

  /* â–¼ ãƒ‰ãƒ©ãƒƒã‚° */
  function startDrag(e) {
    const target = e.target.closest(".rider");
    if (!target) return;
    if (target.style.display === "none") return;
    if (!e.touches && e.shiftKey) return;

    isDragging = true;
    didDrag = false;

    const rect = track.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const px0 = clientX - rect.left;
    const py0 = clientY - rect.top;

    dragPointerAngle0 = Math.atan2(py0 - ellipseCenterY, px0 - ellipseCenterX);

    let groupEls = [];
    const gid = target.dataset.group;

    if (gid) {
      const gNum = parseInt(gid, 10);

      // âœ… ãƒ‰ãƒ©ãƒƒã‚°ã®ä¸¦ã³ã¯ã€Œã‚¿ãƒƒãƒ—é †ã€ã‚’æœ€å„ªå…ˆ
      const orderedNums = (groupTapOrder[gNum] || [])
        .filter(n => enabledNums.has(n) && numToEl[n])
        .filter(n => numToEl[n].dataset.group === gid)
        .filter(n => numToEl[n].style.display !== "none");

      if (orderedNums.length > 0) {
        groupEls = orderedNums.map(n => numToEl[n]).filter(Boolean);
      } else {
        const conf = lineConfig[gNum];
        if (conf && conf.length > 0) {
          groupEls = conf
            .map(n => numToEl[n])
            .filter(Boolean)
            .filter(el => el.style.display !== "none");
        } else {
          groupEls = riders.filter(r => r.dataset.group === gid && r.style.display !== "none");
        }
      }

      const count = groupEls.length;
      const centerIndex = (count - 1) / 2;

      // â˜…å¤‰æ›´ï¼šã‚°ãƒ«ãƒ¼ãƒ—ã¯å¼§é•·ç­‰é–“éš”ç”¨ã® offsetIndex ã‚’æŒãŸã›ã‚‹
      dragItems = groupEls.map((el, idx) => {
        const offsetIndex = idx - centerIndex;
        return { el, offsetIndex, isGroup: true };
      });

    } else {
      const sel = selectedRiders().filter(el => el.style.display !== "none");
      groupEls = (sel.length > 0 && sel.includes(target)) ? sel : [target];

      dragItems = groupEls.map(el => {
        const rRect = el.getBoundingClientRect();
        const cx0 = (rRect.left - rect.left) + rRect.width / 2;
        const cy0 = (rRect.top  - rect.top)  + rRect.height / 2;
        const angle0 = Math.atan2(cy0 - ellipseCenterY, cx0 - ellipseCenterX);
        return { el, angleOffset: angle0 - dragPointerAngle0 };
      });
    }
  }

  function moveDrag(e) {
    if (!isDragging || dragItems.length === 0) return;

    const rect = track.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const px = clientX - rect.left;
    const py = clientY - rect.top;

    const rawPointerAngle = Math.atan2(py - ellipseCenterY, px - ellipseCenterX);

    let angleDiff = normalizeAngleDiff(rawPointerAngle - dragPointerAngle0);
    const scaledDiff = angleDiff * DRAG_SENSITIVITY;

    const pointerAngle = dragPointerAngle0 + scaledDiff;

    if (Math.abs(scaledDiff) > 0.002) didDrag = true;

    // â˜…è¿½åŠ ï¼šã‚°ãƒ«ãƒ¼ãƒ—ã¯å¼§é•·åŸºæº–ã§ç­‰é–“éš”ã«ã™ã‚‹
    const spacingPx = getSpacingPx();
    const pointerLen = lengthAtAngle(pointerAngle);

    dragItems.forEach(item => {
      let angle;

      if (item.isGroup){
        const targetLen = pointerLen + (item.offsetIndex * spacingPx);
        angle = angleAtLength(targetLen);
      } else {
        angle = pointerAngle + item.angleOffset;
      }

      const ex = ellipseCenterX + Math.cos(angle) * ellipseRx * baseRadiusScale;
      const ey = ellipseCenterY + Math.sin(angle) * ellipseRy * baseRadiusScale;

      const left = ex - item.el.offsetWidth / 2;
      const top  = ey - item.el.offsetHeight / 2;

      item.el.style.left = left + "px";
      item.el.style.top  = top  + "px";
    });

    e.preventDefault();
  }

  function endDrag() {
    isDragging = false;
    dragItems = [];
  }

  track.addEventListener("mousedown", startDrag);
  window.addEventListener("mousemove", moveDrag);
  window.addEventListener("mouseup", endDrag);

  track.addEventListener("touchstart", startDrag, { passive:false });
  window.addEventListener("touchmove", moveDrag, { passive:false });
  window.addEventListener("touchend", endDrag);
  window.addEventListener("touchcancel", endDrag);

  /* â–¼ ãƒªã‚»ãƒƒãƒˆãƒ»é¸æŠè§£é™¤ */
  function reset() {
    riders.forEach(r => {
      r.style.left = r.dataset.initLeft;
      r.style.top = r.dataset.initTop;
      delete r.dataset.group;
      r.classList.remove("selected");
      r.style.display = "";
    });
    lineConfig = {1:[],2:[],3:[],4:[],5:[]};
    groupTapOrder = {1:[],2:[],3:[],4:[],5:[]};
    Object.values(lineInputs).forEach(inp => inp.value = "");

    enabledNums = new Set([1,2,3,4,5,6,7,8,9]);
    renderRiderChecks();
    applyEnabledNums();
  }

  function clearSelection() {
    riders.forEach(r => r.classList.remove("selected"));
  }

  resetBtn.addEventListener("click", reset);
  clearSelectionBtn.addEventListener("click", clearSelection);

  /* â–¼ ãƒ¡ãƒ¢ï¼ˆä»•æ§˜å¤‰æ›´ãªã—ï¼‰ */
  saveMemoBtn.addEventListener("click", () => {
    localStorage.setItem(MEMO_KEY, memo.value);
  });
  clearMemoBtn.addEventListener("click", () => {
    memo.value = "";
    localStorage.removeItem(MEMO_KEY);
  });

  /* â–¼ é¸æ‰‹ãƒ¡ãƒ¢ï¼ˆ1äººåˆ†ï¼‰äº’æ›å¯¾å¿œç‰ˆ */
  function normalizeName(name){
    return (name || "").trim().replace(/\s+/g, " ");
  }

  function loadAllRiderMemo(){
    const raw = localStorage.getItem(RIDER_MEMO_KEY);
    if (!raw) return {};
    try {
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === "object" && !Array.isArray(parsed)) return parsed;
      return {};
    } catch {
      return {};
    }
  }

  function saveAllRiderMemo(obj){
    localStorage.setItem(RIDER_MEMO_KEY, JSON.stringify(obj || {}));
  }

  function legacyKeyCandidates(name){
    const n = normalizeName(name);
    if (!n) return [];
    return [
      `riderMemo:${n}`,
      `riderMemo_${n}`,
      `riderMemo-${n}`,
      `${RIDER_MEMO_KEY}:${n}`,
      `${RIDER_MEMO_KEY}_${n}`,
      `${RIDER_MEMO_KEY}-${n}`,
    ];
  }

  function loadOneRiderMemo(name){
    const key = normalizeName(name);
    if(!key) return "";

    const all = loadAllRiderMemo();
    if (all && typeof all === "object" && key in all) return all[key] ?? "";

    for (const lk of legacyKeyCandidates(key)) {
      const v = localStorage.getItem(lk);
      if (v !== null) return v;
    }

    const raw = localStorage.getItem(RIDER_MEMO_KEY);
    if (raw && typeof raw === "string") {
      try { JSON.parse(raw); } catch { return raw; }
    }
    return "";
  }

  function saveOneRiderMemo(name, text){
    const key = normalizeName(name);
    if(!key) return;

    const all = loadAllRiderMemo();
    all[key] = text ?? "";
    saveAllRiderMemo(all);

    // æ—§å½¢å¼äº’æ›ã‚‚ä¿å­˜
    localStorage.setItem(`riderMemo:${key}`, text ?? "");
  }

  function deleteOneRiderMemo(name){
    const key = normalizeName(name);
    if(!key) return;

    const all = loadAllRiderMemo();
    if (all && typeof all === "object") {
      delete all[key];
      saveAllRiderMemo(all);
    }
    for (const lk of legacyKeyCandidates(key)) localStorage.removeItem(lk);
  }

  rmLoad.addEventListener("click", () => {
    const name = rmName.value;
    if(!normalizeName(name)){
      alert("é¸æ‰‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    rmText.value = loadOneRiderMemo(name);
  });

  rmSave.addEventListener("click", () => {
    const name = rmName.value;
    if(!normalizeName(name)){
      alert("é¸æ‰‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    saveOneRiderMemo(name, rmText.value);
  });

  rmPaste.addEventListener("click", () => {
    const name = normalizeName(rmName.value) || "ï¼ˆåå‰æœªå…¥åŠ›ï¼‰";
    const text = (rmText.value || "").trim();

    const block =
      `ã€é¸æ‰‹ãƒ¡ãƒ¢ã€‘${name}\n` +
      (text ? text + "\n" : "\n");

    memo.value = (memo.value || "") + (memo.value ? "\n" : "") + block;
    localStorage.setItem(MEMO_KEY, memo.value);
  });

  rmDelete.addEventListener("click", () => {
    const name = rmName.value;
    if(!normalizeName(name)){
      alert("é¸æ‰‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    deleteOneRiderMemo(name);
    rmText.value = "";
  });

  /* â–¼ ãƒãƒ³ã‚¯è¡¨ç¤º */
  function describeBank(bank) {
    const profile = lengthProfiles[bank.length] || {
      tag: "ãƒãƒ³ã‚¯",
      type: "æ¨™æº–",
      feature: "æ¨™æº–çš„ãªãƒãƒ³ã‚¯ã€‚è„šè³ªã‚ˆã‚Šã‚‚èª¿å­ã¨ä½ç½®å–ã‚ŠãŒé‡è¦ã€‚"
    };

    let feature = profile.feature;
    if (bank.customFeature) feature += " ï¼ " + bank.customFeature;

    bankNameDisplay.textContent = `${bank.fullName}ï¼ˆ${bank.region}ãƒ»${bank.length}mï¼‰`;
    bankTypeDisplay.innerHTML =
      `<span class="bank-tag">${profile.tag}</span>` +
      `<span style="font-size:11px; margin-left:4px;">${profile.type}</span>`;
    bankFeatureDisplay.textContent = "ç‰¹å¾´ï¼š" + feature;

    if (memo && !memo.value.trim()) {
      memo.value = `ã€ãƒãƒ³ã‚¯ã€‘${bank.fullName}ï¼ˆ${bank.length}mï¼‰\nç‰¹å¾´ï¼š${feature}\n`;
    }
  }

  bankSelect.addEventListener("change", () => {
    const key = bankSelect.value;
    const bank = bankMaster[key];
    if (!bank) {
      bankNameDisplay.textContent = "ãƒãƒ³ã‚¯æœªé¸æŠ";
      bankTypeDisplay.innerHTML = '<span class="bank-tag">ã‚¿ã‚¤ãƒ— -</span>';
      bankFeatureDisplay.textContent = "ç‰¹å¾´ï¼š-";
      return;
    }
    describeBank(bank);
  });

  /* â–¼ åˆæœŸåŒ– */
  window.addEventListener("load", () => {
    riders.forEach(r => {
      const cs = getComputedStyle(r);
      r.dataset.initLeft = cs.left;
      r.dataset.initTop = cs.top;
    });

    applySize("small");

    const saved = localStorage.getItem(MEMO_KEY);
    if (saved !== null) memo.value = saved;

    renderRiderChecks();
    applyEnabledNums();

    initRail();
  });

})();
</script>

<!-- ========================== -->
<!-- ã“ã“ã ã‘è¿½åŠ ï¼šãƒŸãƒ‹ãƒ•ãƒƒã‚¿ãƒ¼ -->
<!-- ========================== -->
<div style="
  position: fixed;
  left: 0; right: 0; bottom: 0;
  padding: 8px 10px;
  font-size: 11px;
  color: rgba(0,0,0,.65);
  background: rgba(255,255,255,.86);
  border-top: 1px solid rgba(0,0,0,.12);
  backdrop-filter: blur(6px);
  z-index: 9999;
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
">
  <span>Â© 2026 KEIRIN BOARD</span>
  <a href="../" target="_blank" rel="noopener" style="color:#0066cc;font-weight:700;text-decoration:underline;">
    åˆ©ç”¨è¦ç´„ï¼ˆé…å¸ƒãƒšãƒ¼ã‚¸ï¼‰
  </a>
  <a href="https://x.com/kumatarou_kuma_" target="_blank" rel="noopener" style="color:#0066cc;font-weight:700;text-decoration:underline;">
    å•†ç”¨åˆ©ç”¨ï¼šX DM
  </a>
</div>

</body>
</html>
